<!DOCTYPE html>
<html>
<!DOCTYPE html>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?38db5b6ef50c39b2a0984dab4ed5d001";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<head><meta name="generator" content="Hexo 3.9.0">
	
	<title>记一次回滚 Arch 内核的过程 |  潮与雪 - Rapiz</title>
	<link rel="stylesheet" href="/css/style.css">
	<script src="/js/utils.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!--baidu-->
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ee85bf87ae3384d909e2bbab6d9d1f58";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!--font-->
<script type="text/javascript" src="https://cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
<script type="text/javascript">
   $youziku.load("body", "c1b0ca6cecf2423585df02659c7c50f1", "SourceHan-S-SC");
   /*$youziku.load("#id1,.class1,h1", "c1b0ca6cecf2423585df02659c7c50f1", "SourceHan-S-SC");*/
   /*．．．*/
   $youziku.draw();
</script>
</head>

<body>
<div id = "wrap">
    <header id = "header">
    <div id="nav">
		<div id = "nav-items">
      
        <div class="underline-trans"><a href="/" >Home</a></div>
      
        <div class="underline-trans"><a href="/links" >Links</a></div>
      
        <div class="underline-trans"><a href="/portal" >Protal</a></div>
      
		</ul>
	</div>
</header>


	<main class = 'main' onchange="FanfouFix();">
		<article class="post markdown-body">
  <div class="post-title">
    <h2 class="title">记一次回滚 Arch 内核的过程</h2>
  </div>
   <div class="post-meta">
         
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#内核的安装和编译"><span class="toc-text">内核的安装和编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#从新内核启动"><span class="toc-text">从新内核启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#efibootmgr"><span class="toc-text">efibootmgr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rEFInd"><span class="toc-text">rEFInd</span></a></li></ol></li></ol>
    <span class="post-author">By Rapiz</span>
    <span class="post-time">2017-10-01</span>
  </div>
  <div class="post-content">
    <p>这回<code>sudo pacman -Syu</code>后发现 <code>shutdown</code>, <code>suspend</code> 这些操作都出问题了。我在<code>#archlinux-cn</code>里问了下，得知很有可能是新内核出了 Bug。所以我决定先回滚一下内核看问题能不能解决。</p>
<h2 id="内核的安装和编译"><a href="#内核的安装和编译" class="headerlink" title="内核的安装和编译"></a>内核的安装和编译</h2><p>首先安装LTS内核，当然你选择其他内核也行（记得要把我命令中的<code>linux-lts</code>换成对应的名称）</p>
<pre><code>sudo pacman -S linux-lts</code></pre><p>然后编译</p>
<pre><code>sudo mkinitcpio -p linux-lts</code></pre><p>这时候内核文件已经在<code>/boot</code>下了<br>可以看到</p>
<pre><code>initramfs-linux-lts.img
vmlinuz-linux-lts</code></pre><h2 id="从新内核启动"><a href="#从新内核启动" class="headerlink" title="从新内核启动"></a>从新内核启动</h2><p>如果你使用 Grub，在启动项里或许已经能看到了。当然我不用 Grub 所以我也不知道:)<br>我之前一直使用 EFISTUB 直接启动内核，并且装了一个 rEFInd 以防万一。<br>所以接下来我将修改这两项使之指向新内核。</p>
<h3 id="efibootmgr"><a href="#efibootmgr" class="headerlink" title="efibootmgr"></a>efibootmgr</h3><p>efibootmgr 可以设置从 EFISTUB 启动。<br>添加启动项的命令应该看起来像这样<br><code>sudo efibootmgr -d /dev/sdX -p Y -c -L &quot;Arch Linux&quot; -l /vmlinuz-linux -u &quot;root=/dev/sdBZ rw initrd=/initramfs-linux.img&quot;</code><br>/dev/sdX 和 Y 是 ESP 分区所在的硬盘名称和分区. 让 root= 指向你的root分区，如果你想用UUID指定可以写root=UUID=xxxxxxxx。-u 后面跟内核启动参数。<br>一般笔记本都会加一个 intel 微码的参数。如果你当时装过微码就肯定知道我在说什么。没有也无妨。<br>下面是我实际执行的命令。如果你不需要 intel 微码请把 <code>initrd=/intel-ucode.img</code> 删去。<br><code>sudo efibootmgr -d /dev/sda -p 1 -c -L &quot;Arch Linux with LTS kernel&quot; -l /vmlinuz-linux-lts -u &quot;root=UUID=xxxxxxxxxx rw quiet initrd=/intel-ucode.img initrd=/initramfs-linux-lts.img&quot;</code></p>
<h3 id="rEFInd"><a href="#rEFInd" class="headerlink" title="rEFInd"></a>rEFInd</h3><p>只需要编辑 <code>/boot/refind_linux.conf</code> 把里面的 <code>initramfs-linux</code> 改成 <code>initramfs-linux-lts</code> 就好了。</p>
<p>重启就可以进入新内核了。<br>执行 <code>uname -r</code> 查看现在到底在运行哪个内核。</p>
<p>除了 <code>linux-lts</code> 外，还有众多的内核分支可供选择。<a href="https://wiki.archlinux.org/index.php/Kernels#Official_packages" target="_blank" rel="noopener">打开了折腾的新天地</a>。</p>

  </div>
  <!--hightlight.js-->
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.9.0/styles/idea.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.9.0/highlight.min.js"></script>
<!--  <script src="//cdn.bootcss.com/highlightjs-line-numbers.js/1.1.0/highlightjs-line-numbers.min.js"></script>-->
	<script src="/js/hljs-line-number.js"></script>
  <script>
  hljs.initHighlightingOnLoad();
  hljs.initLineNumbersOnLoad();
  </script>
<!--  <link href="//cdn.bootcss.com/highlight.js/9.9.0/styles/monokai.min.css" rel="stylesheet">
  <script src="//cdn.bootcss.com/highlight.js/9.9.0/highlight.min.js"></script>
  <script>hljs.initHighlighting();</script> -->

</article>

<!-- 如果不是首页且没使用 `comments: false` 关闭评论，则尝试加载评论 -->

    <!-- 配置中启用多说时，导入相应代码 -->
    <!-- 以上皆关闭且 Hexo 配置中设置了 disqus_shortname 时，导入相应代码 -->
    
        <!-- 文件分离和变量的使用，使代码能较好的兼容 Hexo 主配置 -->
        <section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rapiz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>

    


	</main>
</div>
</body>
</html>
