<!DOCTYPE html><html><head><title>从烦人的 WPS &#34;打开方式不对&#34;到翻 Qt 源码 | 潮与雪 - Rapiz</title><link rel="stylesheet" href="/css/style.css"><script src="/js/utils.js"></script><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="robots" content="index,follow"><meta name="author" content="Rapiz"><meta name="keywords" content="潮与雪,Rapiz,OI,ACM,HUST,乔羽佳,博客,Blog,算法,开源软件,题解,DEV"><meta name="description" content="潮与雪,Rapiz,凡人难以承受生活全部的真相，于是他们各执一端。,,从烦人的 WPS &#34;打开方式不对&#34;到翻 Qt 源码,解决 Linux 下 WPS 打开方式问题"><meta name="viewport" content="width=device-width,initial-scale=1"><script src="https://cdn.jsdelivr.net/npm/mermaid@8.5.1/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"neutral"})</script><link rel="canonical" href="https://rapiz.me/2021/fix-wps-mime/"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="潮与雪" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="潮与雪" type="application/rss+xml"></head><body><script src="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js"></script><div id="wrap"><header id="header"><div id="nav"><div id="nav-items"><div class="underline-trans"><a href="/">Home</a></div><div class="underline-trans"><a href="/links">Links</a></div><div class="underline-trans"><a href="/portal">About</a></div></div></div></header><main class="main" onchange="FanfouFix()"><article class="post markdown-body"><div class="post-title"><h1 class="title">从烦人的 WPS &#34;打开方式不对&#34;到翻 Qt 源码</h1></div><div class="post-meta"><blockquote>解决 Linux 下 WPS 打开方式问题</blockquote><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF%E5%92%8C%E8%A1%A8%E7%8E%B0"><span class="toc-text">问题背景和表现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E6%9F%A5%E5%92%8C%E8%A7%A3%E9%87%8A"><span class="toc-text">调查和解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-text">TL; DR</span></a></li></ol><span>In <a class="post-category-link" href="/categories/DEV/">DEV</a> </span><span class="post-author">By Rapiz</span> <span class="post-time">2021-04-13</span> <span class="post-tags"></span></div><div class="post-content"><p></p><h2 id="问题背景和表现"><a href="#问题背景和表现" class="headerlink" title="问题背景和表现"></a>问题背景和表现</h2><p>如果你使用 KDE + archlinux，那么很有可能会遇到这个烦人的问题：WPS 打开文件的方式不对。</p><p>问题表现为，在 KDE 上试图单击打开 .xls 文件的时候，WPS Writer 会被调用，并且很有可能卡死（因为文件内容不匹配）。如果你尝试给 .xls 设置默认程序，会发现可能 .doc, .docx, .ppt, .pptx 也被影响。并且这类文件均被识别成 x-ole-storage 而非独立的 Presentation, Word, Spreedsheet 类型。</p><p>aur 源里有一个叫 wps-office-mime 的包，安装这个包不能解决问题。</p><p>这件事困扰了我很久了，非常烦人，一不小心单击打开表格文件，就会调用 WPS Writer 然后卡死。之前启用 WPS 的整合模式可以解决这个问题，但是自从某个更新后整合模式会崩溃。</p><p>有一天，我再也忍不了了，下定决心要把这件事调查清楚……</p><h2 id="调查和解释"><a href="#调查和解释" class="headerlink" title="调查和解释"></a>调查和解释</h2><p>首先解释一个名词，mimetype，简单来说就是“判断一个文件是什么类型，应该用什么程序打开”的规则。</p><p>前面提到，很多不同的文档文件（doc, ppt, xls) 都被匹配成 <code>x-ole-storage</code> 了，而一个类型的文件只有一个默认打开程序，因此要关联就都关联到 WPS Writer 上从而导致错误结果。</p><p>问题：<strong>我的 .xlsx 文件是怎么被识别成 x-ole-storage 文件并打开的？</strong></p><p>我打开 KDE 的 File Associations，里面确实有 .ppt, .doc, .xls 的 mimetypes 及其关联的打开程序，看起来非常正常。但是为什么这些规则没有匹配到我的文件上呢？为什么文件没有被正确归类成幻灯片，文档，表格，而是那个不知哪里来的 x-ole-storage 类型？</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://wiki.archlinux.org/index.php/XDG_MIME_Applications">ArchWiki 有关于 mimetypes 的一些介绍</a>。其中提到系统直接读取的 mimetypes 其实是一种数据库，或者说缓存，是根据安装过的软件包的原始 mimetype 配置文件生成的结果。</p><p>原始 mimetype 配置文件储存在：</p><ul><li><p><code>/usr/share/mime/packages</code></p></li><li><p><code>~/.local/share/mime/packages</code></p></li></ul><p>并且我们可以用 <code>update-mime-database</code> 来根据配置刷新缓存。</p><p>好吧，可是这些知识对于解决我的问题并没有帮助。</p><p>不过，至少经过在这些目录里搜索，我发现 <code>x-ole-storage</code> 的定义来源于 <code>/usr/share/mime/packages/freedesktop.xml</code>，属于 XDG 标准内容，看来我不应该删除掉它的定义。</p><p><strong>看来需要调查 KDE 识别并打开文件的过程了。</strong></p><p>根据日常使用 KDE 的经验和猜想，在 Dolphin 里单击一个文件，和使用 <code>xdg-open</code> 命令的效果是完全相同的。经过一些搜索，我发现 <code>xdg-open</code> 依赖 <code>kde-cli-tools</code> 包来打开文件，那么想要调查 KDE 打开文件，自然要去看这个包里都有什么工具了。</p><p>找到其<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/KDE/kde-cli-tools/">源码</a>，看一下目录结构初步判断确实和 mimetype 有关。浏览源码的时候发现一个工具 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/KDE/kde-cli-tools/blob/8dfe577f3de7fed03288b8eb2b27384b91feaaee/kmimetypefinder/kmimetypefinder.cpp">kmimetypefinder5</a>，这部分代码看起来对于追踪 KDE 处理 mimetype 的流程非常有用！我在终端调用 <code>kmimetypefinder5 somefile.xlsx</code>，发现返回结果是 <code>x-ole-stroage</code>，我复现了想要的错误。接下来就是看这个工具的源码，一点一点找在哪里 mimetype 没有正确匹配了。</p><p>还好这个工具的源码很简单，我很快发现它是调用 Qt 库中的 <code>QMimeDatabase</code> 来判断 mimetype 的。</p><p><strong>所以只能看看 Qt 库在干什么了。</strong>首先读了一下对应 Qt 文档，发现只说明了提供的接口，没有介绍判断逻辑。</p><p>那么接下来只能读源码了。</p><p>Google “QMimeDatabase source” 很快定位到了我想要的东西</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://code.woboq.org/qt5/qtbase/src/corelib/mimetypes/qmimedatabase.cpp.html#_ZN20QMimeDatabasePrivate26mimeTypeForFileNameAndDataERK7QStringP9QIODevicePi-">Qt Source Code</a></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">QMimeType QMimeDatabasePrivate::mimeTypeForFileNameAndData(const QString &amp;fileName, QIODevice *device, int *accuracyPtr)
&#123;
    &#x2F;&#x2F; First, glob patterns are evaluated. If there is a match with max weight,
    &#x2F;&#x2F; this one is selected and we are done. Otherwise, the file contents are
    &#x2F;&#x2F; evaluated and the match with the highest value (either a magic priority or
    &#x2F;&#x2F; a glob pattern weight) is selected. Matching starts from max level (most
    &#x2F;&#x2F; specific) in both cases, even when there is already a suffix matching candidate.</code></pre><p>所以说，KDE 经过一系列调用之后，最终调用 Qt 库中这个函数来获取一个文件的 mimetype, 然后用关联的默认程序来打开文件。</p><p>简单阅读注释 + 代码，发现 Qt 是根据文件的扩展名和 Magic Number 共同启发式推断文件的类型。也就是说，如果有多个匹配，Qt 会给这些匹配结果分配权重，然后选择权重最高的匹配结果。</p><p>没看多远，<strong>我就发现了一条我最想要的匹配规则</strong>：如果根据文件扩展名的规则匹配，有唯一的匹配结果，那么立刻返回这个匹配。</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">
&#x2F;&#x2F; Pass 1) Try to match on the file name
QMimeGlobMatchResult candidatesByName;
if (fileName.endsWith(QLatin1Char(&#39;&#x2F;&#39;)))
    candidatesByName.addMatch(QLatin1String(&quot;inode&#x2F;directory&quot;), 100, QString());
else
    candidatesByName &#x3D; findByFileName(QFileInfo(fileName).fileName());
if (candidatesByName.m_allMatchingMimeTypes.count() &#x3D;&#x3D; 1) &#123;
    *accuracyPtr &#x3D; 100;
    const QMimeType mime &#x3D; mimeTypeForName(candidatesByName.m_matchingMimeTypes.at(0));
    if (mime.isValid())
        return mime;
    candidatesByName &#x3D; &#123;&#125;;
&#125;</code></pre><p>看到这里，不需要阅读后面的源码，谜底也已经解开了，解决方案已经有了。<strong>让我的系统里对于 .doc 等文件只有一种匹配。</strong></p><p>打开 KDE File Associations, 把 WPS 加进来的乱七八糟的 mimetypes 删干净，只留下 XDG 标准定义的文档类型，并且为其设置正确的独立程序，如 *.ppt 默认使用 WPS Presentation 而非 WPS 2019 打开。</p><p>测试一下，<strong>终于成了！</strong>我终于能在 Linux 下不糟心的阅读 Office 文档了！<em>对，我们用 Linux 的就是会糟心这种问题……</em></p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL; DR"></a>TL; DR</h2><p>一句话解决方案：在系统设置里清理 mimetype，把重复匹配 .doc/.docx/.ppt/.pptx 等等的 mimetype 删的只剩下一个，保证每个后缀名只在一个 mimetype 里出现一次。</p><p>如果系统设置里删不掉，就找上文提到的“原始 mimetype 配置文件储存路径”</p><ul><li><code>/usr/share/mime/packages</code></li><li><code>~/.local/share/mime/packages</code></li></ul><p>并用合适的参数调用 <code>update-mime-database</code></p><p>相信被这个问题困扰的 Linux 用户不少，希望能帮到你 :)</p><p>感谢阅读</p></div></article><div class="page-nav"><div class="underline-trans"><a href="/2021/hands-on-os-modern-toolchain/">自己动手写操作系统-现代工具链 ▶</a></div></div><section id="comments"><div id="disqus_thread"><script type="text/javascript">var disqus_shortname="rapiz";function loadDisqus(){var e=document,n=e.createElement("script");n.src="https://"+disqus_shortname+".disqus.com/embed.js",n.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(n),window.disqus_config=function(){this.page.url="https://rapiz.me/2021/fix-wps-mime/",this.page.identifier="/2021/fix-wps-mime/"}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout(function(){var n;!isBot&&supportsIntersectionObserver?(n=new IntersectionObserver(function(e){e[0].isIntersecting&&(loadDisqus(),n.disconnect())},{threshold:[0]})).observe(document.getElementById("disqus_thread")):loadDisqus()},1)</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener external nofollow noreferrer" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></main><div id="typography-footer"><p>Powered by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a> | <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Rapiz1/typography">Typography</a> designed by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Rapiz1">Rapiz</a></p><span id="busuanzi_container_page_pv">PV: <span id="busuanzi_value_page_pv"></span></span></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-168447368-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-168447368-1")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src=https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML></body></html>